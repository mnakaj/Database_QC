---
title: "Quality Control"
author: "Mia Nakajima"
date: "6/12/2018"
output: 
  html_document:
    keep_md: true

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(plyr)
library(kernlab)
library(dplyr)
library(RJSONIO)
library(XML)
```



```{r}
#without citations
database2 <- read.csv("~/Documents/try10.csv", sep = ",", header = TRUE, stringsAsFactors = FALSE)
id <- seq(from = 1, to = length(database2[[1]]), by = 1)
database2 <- data.frame(id, database2)
```



```{r}
## Rows to divide database by
#1 - 9290
#9291 - 20999
#21000 - 27024 
#27025 - 61717
#61718 - 65184
#65185 - 78347
test <- database2[1:74,]
data1 <- database2[1:500, ]
data2 <- database2[9291:20999,]
data3 <- database2[21000:27024,]
data4 <- database2[27025:61717,]
data5 <- database2[61718:65184,]
data6 <- database2[65185:78347,]
```
```{r}
head(test)
```

# Basic Identifiers 

## Publication (Citation)

Skip for now.

## Data contributor 

```{r}
scrap <- test$Data.contributor
#scrap <- c("c12", "Jessica")
if (sum(grepl("[[:digit:]]", scrap)) > 0){
  print("There seems to be a name with a possible typo. Please check and then proceed.")
}
```

## Year

```{r}

#check for any characters other than numbers

#quick check 
#test$Year <- c(rep("10", 72), "199c", "19999")
year_vec <- grepl("[^0-9]", test$Year)

if (length(which(year_vec)) > 0){
  print("There seems to be a year with a non-numeric character. Please check and then proceed.")
  
  print(test[which(year_vec), c(1,2, 3)])
}


#check that there are only 4 digits

num_year <- nchar(gsub(" ", "", test$Year))

if (length(num_year[num_year != 4]) > 0){
  print("There seems to be a date that is not formatted correctly. Please check and then proceed.")
  
   print(test[which(ifelse(num_year !=4, TRUE, FALSE)), c(1,2, 3)])
} else {
  print("looks good!")
}




```



## Season

Note: Do we want this to be case-sensitive? 
```{r}
#test
#test$Season <- c(rep("spring", 11706), "Summer", "Autumn", "Dry")

seasons <- factor(test$Season, levels = c("Spring", "Summer", "Autumn", "Winter", "Dry", "Humid"))

if (length(which(is.na(seasons))) > 0){
  print("Please check that season is correct before preceeding.")
  print(test[which(is.na(seasons)), c(1, 2, 4)])
} else{
  print("Ok")
}

```


## Climate

Note: Also need to do the code classification
```{r}

#use kgc package that has databases of Koppen climate class 
#koppen <- read.table("~/Downloads/Koeppen-Geiger-ASCII.txt", header = TRUE)
climate_names <- read.csv("~/Documents/summer_18/kfc_climates.csv", header = TRUE)

names <- factor(test$Climate, levels = levels(climate_names$Climate.Name))

if (length(which(is.na(names)))>0) {
  
  print("There seems to be codes that do not match the Koppen climate classification. Please check below and then proceed.")
  print(test[which(is.na(codes)), c(1,2, 5)])
}

```



## Country 


```{r}

# code help from https://www.r-bloggers.com/using-rvest-to-scrape-an-html-table/
library(rvest)

#webscrape countrycodes table 
url <- "https://wiki.openstreetmap.org/wiki/Nominatim/Country_Codes"


countrycodes <- url %>%
  read_html() %>%
  html_nodes(xpath='//*[@id="mw-content-text"]/div/table') %>%
  html_table() 
  
countrycodes <- countrycodes[[1]]

countrycodes <- countrycodes[, 1:2]
names(countrycodes) <- c("CountryCode", "CountryName")


#countrycodes$CountryCode <- factor(countrycodes$CountryCode)
countrycodes$CountryName <- factor(countrycodes$CountryName)

#need to make sure blanks get read in as "" instead of NA

countries <- factor(test$Country, levels = levels(countrycodes$CountryName), order = TRUE)

if (length(which(is.na(countries))) > 0){
  print("Please check that country is not mistyped before preceeding.")
  print(test[which(is.na(seasons)), c(1, 2, 7)])
} else{
  print("Ok")
}

```


## City


Need to get country codes of the countries. So good to check that the countries all exist first. 
 
```{r}
#code adapted from https://stackoverflow.com/questions/13905098/how-to-get-the-longitude-and-latitude-coordinates-from-a-city-name-and-country-i


code <- c()
for (country in test$Country){
  
  index <- which(levels(countrycodes$CountryName) == country)
  code <- c(code, countrycodes$CountryCode[index])

  
}

test_codes <- data.frame(code, test$City)
names(test_codes) <- c("CountryCode", "CityName")
head(test_codes)


```

```{r}
nrow <- nrow(test_codes)
counter <- 1
test_codes$lon[counter] <- 0
test_codes$lat[counter] <- 0
while (counter <= nrow){
  CityName <- gsub(' ','%20',test_codes$CityName[counter]) #remove space for URLs
  CountryCode <- test_codes$CountryCode[counter]
  url <- paste(
    "http://nominatim.openstreetmap.org/search?city="
    , CityName
    , "&countrycodes="
    , CountryCode
    , "&limit=9&format=json"
    , sep="")
  x <- fromJSON(url)
  if(is.vector(x)){
    test_codes$lon[counter] <- x[[1]]$lon
    test_codes$lat[counter] <- x[[1]]$lat    
  }
  counter <- counter + 1
  Sys.sleep(1.1) #to comply with website usage guidelines 
}
```



## Building type

```{r}
test <- data3

# would we want Other instead of Others
# also caps check? 
buildings <- factor(test$Building.type, levels = c("Classroom", "Multifamily housing", "Office", "Senior center", "Others"))

if (length(which(is.na(buildings))) > 0){
  print("try again")
  
  print(test[which(is.na(buildings)), c(1, 8)])
} else {
  print("ok")
}
```


## Cooling strategy 

```{r}
#test <- database2[800:900,]

#test$Cooling.startegy <- c(rep("NA", 100), "hi")
cooling <- factor(sapply(test$Cooling.startegy, toString), levels = c("Air Conditioned", "Mechanical Ventilation", "Mixed-mode", "Natural Ventilation", "NA"))

if (length(which(is.na(cooling))) > 0){
  print("no")
  print(test[which(is.na(cooling)), c(1, 9)])
} else{
  print("yes")
}
```


## Heating strategy 

Can't find heating strategy column??
```{r}
#test <- database2[800:900,]

#test$Cooling.startegy <- c(rep("NA", 100), "hi")
heating <- factor(sapply(test$Cooling.startegy, toString), levels = c("Mechanical Heating", "NA"))


if (length(which(is.na(heating))) > 0){
  print("no")
  print(test[which(is.na(heating)), c(1, 9)]) #need to fix heating index
} else{
  print("yes")
}
```

#Subjects' Personal Information

## Age

```{r}
is_int_age <- sapply(test$Age, is.integer)

if (length(which(!is_int_age)) > 0){
  print("Please fix non-integer age values.")
  print(test[which(!is_int_age), c(1, 10)])
}

age_range <- ifelse(test$Age <= 100 || test$Age >= 0, FALSE, TRUE)

if (length(which(age_range)) > 0){
  print("Age seems unusually high or low. Please check and then proceed.")
  print(test[which(age_range), c(1, 10)])
}else{
  print("All looks good.")
}
```


## Sex

```{r}
sex <- factor(test$Sex, levels = c("Male", "Female"))

if (length(which(is.na(sex))) > 0){
  print("try again")
  
  print(test[which(is.na(sex)), c(1, 11)])
} else {
  print("ok")
}
```


## Subject's Weight

```{r}
is_num_weight <- sapply(test$`Subject.s.weight.kg.`, is.numeric)

if (length(which(!is_num_weight)) > 0){
  print("Please fix non-numeric weight values.")
  print(test[which(!is_num_weight), c(1, 63)]) #may need to fix index
}

weight_range <- ifelse(test$`Subject.s.weight.kg.` <= 150 || test$`Subject.s.weight.kg.` >= 15, FALSE, TRUE)

if (length(which(weight_range)) > 0){
  print("Some weights seems unusually high or low. Please check and then proceed.")
  print(test[which(weight_range), c(1, 63)]) #fix index
}else{
  print("All looks good.")
}
```


## Subject's Height

```{r}
is_num_height <- sapply(test$`Subject.s.height..cm.`, is.numeric)

if (length(which(!is_num_height)) > 0){
  print("Please fix non-numeric height values.")
  print(test[which(!is_num_height), c(1, 62)])
}

height_range <- ifelse(test$`Subject.s.height..cm.` <= 250 || test$test$`Subject.s.height..cm.` >= 60, FALSE, TRUE)

if (length(which(height_range)) > 0){
  print("Some heights seems unusually high or low. Please check and then proceed.")
  print(test[which(height_range), c(1, 62)]) #fix index 
}else{
  print("All looks good.")
}
```

#Subjective Thermal Comfort Information 

## Thermal sensation

```{r}
library(ggplot2)
ggplot(test, aes(x = `Air.temperature...F.`, y = Thermal.sensation)) + geom_point()


fit <- lm(Thermal.sensation ~ `Air.temperature...F.`, data=test)
summary(fit) # show results
```


## Thermal acceptibility

```{r}
accept <- df3$`Thermal sensation acceptability`
temp <- df3$`Air temperature (째F)`

ggplot(df3, aes(x =`Thermal sensation`)) + geom_bar(aes(fill = factor(`Thermal sensation acceptability`)))
```
```{r}

```


```{r}
accept <- new_df$`Thermal sensation acceptability`
temp <- new_df$`Air temperature (째F)`

ggplot(new_df, aes(x =`Thermal sensation`)) + geom_bar(aes(fill = factor(`Thermal sensation acceptability`)))
```
```{r}
library(dplyr)
```

```{r}
accept <- count(new_df, vars = `Thermal sensation`, wt_var = `Thermal sensation acceptability`)

summ <- accept %>% 
  group_by(vars) %>% 
  mutate(total = sum(n)) %>% 
  mutate(prop = n/total)

accept_1 <- accept %>% 
  filter(wt_var == 1)
```
```{r}
accept_1

```

```{r}
ggplot(accept_1, aes(x = vars, y = n)) + geom_point()
```
```{r}
fit <- lm(n ~ I(vars^2), data = accept_1)
summary(fit)
```

```{r}
accept <- df3$`Thermal sensation acceptability`
temp <- df3$`Air temperature (째F)`

ggplot(df3, aes(x =`Thermal sensation`, y = `Thermal sensation acceptability`)) + geom_point(aes(col = `Thermal sensation acceptability`))
```

## Thermal preference

```{r}
ggplot(new_df, aes(x= round(`Thermal sensation`), y = `Thermal preference` )) + geom_bar(aes(fill = factor(`Thermal preference`)), position = "fill", stat = 'identity')
```

```{r}
ggplot(new_df, aes(x= `Air temperature (째F)`, y = `Thermal preference` )) + geom_point(aes(col = `Thermal preference`))
```
```{r}
ggplot(df3, aes(x=`Thermal sensation`, y = `Thermal preference` )) + geom_bar(aes(fill = factor(`Thermal preference`)), position = "fill", stat = 'identity')
```



```{r}
pref <- count(new_df, vars = `Thermal sensation`, wt_vars = `Thermal preference`)

cooler <- pref %>% 
  group_by(vars) %>%
  mutate(total = sum(n)) %>% 
  mutate(prop = n/total) %>%
  filter(wt_vars == "cooler")

warmer <- pref %>% 
  group_by(vars) %>%
  mutate(total = sum(n)) %>% 
  mutate(prop = n/total) %>%
  filter(wt_vars == "warmer")

```
```{r}
plot(warmer$vars, warmer$prop)
```

```{r}
plot(cooler$vars, cooler$prop)
```

```{r}
fit_cooler <- lm(prop ~ vars, data = cooler)
summary(fit_cooler)
```
```{r}
fit_warmer <- lm(prop ~ vars, data = warmer)
summary(fit_warmer)
```


```{r}
djamala <- df %>% filter(`Data contributor` == "Djamila")
```

```{r}
ggplot(djamala, aes(x=`Thermal sensation`, y = `Thermal preference` )) + geom_bar(aes(fill = factor(`Thermal preference`)), position = "fill", stat = 'identity')
```

```{r}
pref <- count(new_df, vars = `Thermal sensation`, wt_vars = `Thermal preference`)

cooler <- pref %>% 
  group_by(vars) %>%
  mutate(total = sum(n)) %>% 
  mutate(prop = n/total) %>%
  filter(wt_vars == "cooler")

warmer <- pref %>% 
  group_by(vars) %>%
  mutate(total = sum(n)) %>% 
  mutate(prop = n/total) %>%
  filter(wt_vars == "warmer")

```
```{r}
plot(cooler$vars, cooler$prop)
```


```{r}
fit_cooler <- lm(prop ~ vars, data = cooler)
summary(fit_cooler)
```
```{r}
fit_warmer <- lm(prop ~ vars, data = warmer)
summary(fit_warmer)
```
## Air movement acceptibility

## Air movement preference
```{r}
ggplot(df3, aes(x = round(`Air velocity (m/s)`, digits = 2))) + geom_bar(aes(fill = factor(`Air movement preference`)), position = "fill")
```

## Thermal comfort

## Clo



## Met

## Activity_10

## Activity_20

## Activity_30

## Activity_60

## Humidity sensation

# Instrumented Thermal Comfort Measurements

## Air temperature

## Ta_h

## Ta_m

## Ta_l

## Operative temperature

## Radiant temperature

## Globe temperature

## Tg_h

## Tg_m

## Tg_l

## Relative humidity

## Air velocity

## Velocity_h

## Velocity_m

## Velocity_l

# Calculated Indices

## PMV

## PPD

# Environmental Control

## Blind (curtain)

## Fan

## Window

## Door

## Heater

## Outdoor monthly air temperature